import{LitElement as e,css as t,html as i}from"../../build/es6/node_modules/lit-element/lit-element.js";import"../../build/es6/node_modules/@lrnwebcomponents/anchor-behaviors/anchor-behaviors.js";import"../../build/es6/node_modules/@lrnwebcomponents/simple-toast/simple-toast.js";import"../../build/es6/node_modules/@lrnwebcomponents/simple-icon/lib/simple-icon-button-lite.js";import"../../build/es6/node_modules/@lrnwebcomponents/simple-popover/simple-popover.js";import"../../build/es6/node_modules/@lrnwebcomponents/simple-icon/simple-icon.js";const s=function(){const e={namespaces:{tei:"http://www.tei-c.org/ns/1.0",teieg:"http://www.tei-c.org/ns/Examples",rng:"http://relaxng.org/ns/structure/1.0"},tei:{eg:["<pre>","</pre>"],ptr:['<a href="$rw@target">$@target</a>'],ref:[["[target]",['<a href="$rw@target">',"</a>"]]],graphic:function(e){const t=new Image;return t.src=this.rw(e.getAttribute("url")),e.hasAttribute("width")&&t.setAttribute("width",e.getAttribute("width")),e.hasAttribute("height")&&t.setAttribute("height",e.getAttribute("height")),t},list:[["[type=gloss]",function(e){const t=document.createElement("dl");for(const i of Array.from(e.children))if(i.nodeType==Node.ELEMENT_NODE){if("tei-label"==i.localName){const e=document.createElement("dt");e.innerHTML=i.innerHTML,t.appendChild(e)}if("tei-item"==i.localName){const e=document.createElement("dd");e.innerHTML=i.innerHTML,t.appendChild(e)}}return t}]],note:[["[place=end]",function(e){this.noteIndex?this.noteIndex++:this.noteIndex=1;const t="_note_"+this.noteIndex,i=document.createElement("a");i.setAttribute("id","src"+t),i.setAttribute("href","#"+t),i.innerHTML=this.noteIndex;const s=document.createElement("sup");s.appendChild(i);let n=this.dom.querySelector("ol.notes");n||(n=document.createElement("ol"),n.setAttribute("class","notes"),this.dom.appendChild(n));const o=document.createElement("li");return o.id=t,o.innerHTML=e.innerHTML,n.appendChild(o),s}],["_",["(",")"]]],table:function(e){const t=document.createElement("table");if(t.innerHTML=e.innerHTML,"tei-head"==t.firstElementChild.localName){const e=t.firstElementChild;e.remove();const i=document.createElement("caption");i.innerHTML=e.innerHTML,t.appendChild(i)}for(const e of Array.from(t.querySelectorAll("tei-row"))){const t=document.createElement("tr");t.innerHTML=e.innerHTML;for(const i of Array.from(e.attributes))t.setAttribute(i.name,i.value);e.parentElement.replaceChild(t,e)}for(const e of Array.from(t.querySelectorAll("tei-cell"))){const t=document.createElement("td");e.hasAttribute("cols")&&t.setAttribute("colspan",e.getAttribute("cols")),t.innerHTML=e.innerHTML;for(const i of Array.from(e.attributes))t.setAttribute(i.name,i.value);e.parentElement.replaceChild(t,e)}return t},teiHeader:function(e){this.hideContent(e,!1)},title:[["tei-titlestmt>tei-title",function(e){const t=document.createElement("title");t.innerHTML=e.innerText,document.querySelector("head").appendChild(t)}]]},teieg:{egXML:function(e){const t=document.createElement("pre");return t.innerHTML=this.serialize(e,!0),t}}};class t{constructor(t){if(this.els=[],this.namespaces=new Map,this.behaviors={},this.hasStyle=!1,this.prefixDefs=[],t)this.base=t;else try{window&&(this.base=window.location.href.replace(/\/[^\/]*$/,"/"))}catch(e){this.base=""}this.addBehaviors(e),this.shadowCSS,this.supportsShadowDom=document.head.createShadowRoot||document.head.attachShadow}getHTML5(e,t,i){window.location.href.startsWith(this.base)&&e.indexOf("/")>=0&&(this.base=e.replace(/\/[^\/]*$/,"/"));return new Promise((t,i)=>{const s=new XMLHttpRequest;s.open("GET",e),s.send(),s.onload=function(){this.status>=200&&this.status<300?t(this.response):i(this.statusText)},s.onerror=function(){i(this.statusText)}}).catch(e=>{console.log(e)}).then(e=>this.makeHTML5(e,t,i))}makeHTML5(e,t,i){const s=(new DOMParser).parseFromString(e,"text/xml");return this.domToHTML5(s,t,i)}domToHTML5(e,t,s){this._learnElementNames(e);const n=e=>{let t;if(this.namespaces.has(e.namespaceURI?e.namespaceURI:"")){const i=this.namespaces.get(e.namespaceURI?e.namespaceURI:"");t=document.createElement(`${i}-${e.localName}`)}else t=document.importNode(e,!1);for(const i of Array.from(e.attributes))"xmlns"==i.name?t.setAttribute("data-xmlns",i.value):t.setAttribute(i.name,i.value),"xml:id"==i.name&&t.setAttribute("id",i.value),"xml:lang"==i.name&&t.setAttribute("lang",i.value),"rendition"==i.name&&t.setAttribute("class",i.value.replace(/#/g,""));if(t.setAttribute("data-origname",e.localName),0==e.childNodes.length&&t.setAttribute("data-empty",""),"tagsDecl"==e.localName){const i=document.createElement("style");for(const t of Array.from(e.childNodes))if(t.nodeType==Node.ELEMENT_NODE&&"rendition"==t.localName&&"css"==t.getAttribute("scheme")){let e="";t.hasAttribute("selector")?(e+=t.getAttribute("selector").replace(/([^#, >]+\w*)/g,"tei-$1").replace(/#tei-/g,"#")+"{\n",e+=t.textContent):(e+=`.${t.getAttribute("xml:id")}{\n`,e+=t.textContent),e+="\n}\n",i.appendChild(document.createTextNode(e))}i.childNodes.length>0&&(t.appendChild(i),this.hasStyle=!0)}"prefixDef"==e.localName&&(this.prefixDefs.push(e.getAttribute("ident")),this.prefixDefs[e.getAttribute("ident")]={matchPattern:e.getAttribute("matchPattern"),replacementPattern:e.getAttribute("replacementPattern")});for(const i of Array.from(e.childNodes))i.nodeType==Node.ELEMENT_NODE?t.appendChild(n(i)):t.appendChild(i.cloneNode());return s&&s(t,e),t};if(this.dom=n(e.documentElement),this.applyBehaviors(),this.done=!0,!t)return window.dispatchEvent(i),this.dom;t(this.dom,this),window.dispatchEvent(i)}applyBehaviors(){window.customElements?this.define(this.els):this.fallback(this.els)}addStyle(e,t){this.hasStyle&&e.getElementsByTagName("head").item(0).appendChild(t.getElementsByTagName("style").item(0).cloneNode(!0))}addShadowStyle(e){this.shadowCSS&&(e.innerHTML=`<style>@import url("${this.shadowCSS}");</style>${e.innerHTML}`)}addBehaviors(e){if(e.namespaces)for(const t of Object.keys(e.namespaces))this.namespaces.has(e.namespaces[t])||Array.from(this.namespaces.values()).includes(t)||this.namespaces.set(e.namespaces[t],t);for(const t of this.namespaces.values())if(e[t])for(const i of Object.keys(e[t]))this.behaviors[`${t}:${i}`]=e[t][i];if(e.handlers)for(const t of Object.keys(e.handlers))"egXML"!==t?this.behaviors["tei:"+t]=e.handlers[t]:this.behaviors["teieg:egXML"]=e.handlers[t];e.fallbacks&&console.log("Fallback behaviors are no longer used.")}addBehavior(e,t,i){let s;if(e===Object(e))for(const t of Object.keys(e))this.namespaces.has(e[t])||(this.namespaces.set(e[t],t),s=t);else s=e;this.behaviors[`${s}:${t}`]=i}unsetNamespace(e){this.namespaces.delete(e)}setBaseUrl(e){this.base=e}_learnElementNames(e){const t=e.documentElement;this.els=new Set(Array.from(t.querySelectorAll("*"),e=>(this.namespaces.has(e.namespaceURI?e.namespaceURI:"")?this.namespaces.get(e.namespaceURI?e.namespaceURI:"")+":":"")+e.localName)),this.els.add((this.namespaces.has(t.namespaceURI?t.namespaceURI:"")?this.namespaces.get(t.namespaceURI?t.namespaceURI:"")+":":"")+t.localName)}_insert(e,t){const i=document.createElement("span");for(const t of Array.from(e.childNodes))t.nodeType!==Node.ELEMENT_NODE||t.hasAttribute("data-processed")||this._processElement(t);if(t[0].match("<[^>]+>")&&t[1]&&t[1].match("<[^>]+>")){i.innerHTML=t[0]+(t[1]?t[1]:"");for(const t of Array.from(e.childNodes))i.firstElementChild.appendChild(t.cloneNode(!0))}else{i.innerHTML=t[0],i.setAttribute("data-before",t[0].replace(/<[^>]+>/g,"").length);for(const t of Array.from(e.childNodes))i.appendChild(t.cloneNode(!0));t.length>1&&(i.innerHTML+=t[1],i.setAttribute("data-after",t[1].replace(/<[^>]+>/g,"").length))}return i}_processElement(e){if(e.hasAttribute("data-origname")&&!e.hasAttribute("data-processed")){const t=this.getFallback(this._bName(e));t&&(this.append(t,e),e.setAttribute("data-processed",""))}for(const t of Array.from(e.childNodes))t.nodeType===Node.ELEMENT_NODE&&this._processElement(t)}_template(e,t){let i=e;if(e.search(/\$(\w*)(@([a-zA-Z:]+))/)){const s=/\$(\w*)@([a-zA-Z:]+)/g;let n;for(;n=s.exec(e);)t.hasAttribute(n[2])&&(i=n[1]&&this[n[1]]?i.replace(n[0],this[n[1]].call(this,t.getAttribute(n[2]))):i.replace(n[0],t.getAttribute(n[2])))}return i}_tagName(e){return e.includes(":"),e.replace(/:/,"-").toLowerCase()}_bName(e){return`${e.tagName.substring(0,e.tagName.indexOf("-")).toLowerCase()}:${e.getAttribute("data-origname")}`}decorator(e){if(Array.isArray(e)&&!Array.isArray(e[0]))return this._decorator(e);const t=this;return function(i){for(const s of e)if(i.matches(s[0])||"_"===s[0])return Array.isArray(s[1])?t._decorator(s[1]).call(t,i):s[1].call(t,i)}}_decorator(e){const t=this;return function(i){const s=[];for(let n=0;n<e.length;n++)s.push(t._template(e[n],i));return t._insert(i,s)}}getHandler(e){if(this.behaviors[e])return"[object Function]"==={}.toString.call(this.behaviors[e])?this.append(this.behaviors[e]):this.append(this.decorator(this.behaviors[e]))}getFallback(e){if(this.behaviors[e])return"[object Function]"==={}.toString.call(this.behaviors[e])?this.behaviors[e]:this.decorator(this.behaviors[e])}append(e,t){if(!t){const t=this;return function(){if(!this.hasAttribute("data-processed")){const i=e.call(t,this);i&&!t._childExists(this.firstElementChild,i.nodeName)&&t._appendBasic(this,i)}}}{const i=e.call(this,t);i&&!this._childExists(t.firstElementChild,i.nodeName)&&this._appendBasic(t,i)}}attach(e,t,i){if(e[t].call(e,i),i.nodeType===Node.ELEMENT_NODE)for(const e of Array.from(i.childNodes))this._processElement(e)}_childExists(e,t){return!(!e||e.nodeName!=t)||e&&e.nextElementSibling&&this._childExists(e.nextElementSibling,t)}_appendShadow(e,t){const i=e.attachShadow({mode:"open"});this.addShadowStyle(i),i.appendChild(t)}_appendBasic(e,t){this.hideContent(e),e.appendChild(t)}registerAll(e){this.define(e)}define(e){for(const t of e)try{const e=this.getHandler(t);window.customElements.get(this._tagName(t))||window.customElements.define(this._tagName(t),class extends HTMLElement{constructor(){super(),this.matches(":defined")||(e&&e.call(this),this.setAttribute("data-processed",""))}connectedCallback(){this.hasAttribute("data-processed")||(e&&e.call(this),this.setAttribute("data-processed",""))}})}catch(e){console.log('Check that  xmlns="http://www.tei-c.org/ns/1.0" is set'),console.log(this._tagName(t)+" couldn't be registered or is already registered."),console.log(e)}}fallback(e){for(const t of e){const e=this.getFallback(t);if(e)for(const i of Array.from((this.dom&&!this.done?this.dom:document).getElementsByTagName(this._tagName(t))))i.hasAttribute("data-processed")||this.append(e,i)}}rw(e){return e.match(/^(?:http|mailto|file|\/|#).*$/)?e:this.base+e}first(e){return e.replace(/ .*$/,"")}normalizeURI(e){return this.rw(this.first(e))}repeat(e,t){let i="";for(let s=0;s<t;s++)i+=e;return i}copyAndReset(e){const t=e=>{const i=e.nodeType===Node.ELEMENT_NODE?document.createElement(e.nodeName):e.cloneNode(!0);if(e.attributes)for(const t of Array.from(e.attributes))"data-processed"!==t.name&&i.setAttribute(t.name,t.value);for(const s of Array.from(e.childNodes))if(s.nodeType==Node.ELEMENT_NODE){if(!e.hasAttribute("data-empty")){if(s.hasAttribute("data-original")){for(const e of Array.from(s.childNodes)){const s=i.appendChild(t(e));s.nodeType===Node.ELEMENT_NODE&&s.hasAttribute("data-origid")&&(s.setAttribute("id",s.getAttribute("data-origid")),s.removeAttribute("data-origid"))}return i}i.appendChild(t(s))}}else i.appendChild(s.cloneNode());return i};return t(e)}serialize(e,t){let i="";if(!t){i+="&lt;"+e.getAttribute("data-origname");for(const t of Array.from(e.attributes))t.name.startsWith("data-")||["id","lang","class"].includes(t.name)||(i+=` ${t.name}="${t.value}"`),"data-xmlns"==t.name&&(i+=` xmlns="${t.value}"`);e.childNodes.length>0?i+=">":i+="/>"}for(const t of Array.from(e.childNodes))switch(t.nodeType){case Node.ELEMENT_NODE:i+=this.serialize(t);break;case Node.PROCESSING_INSTRUCTION_NODE:i+=`&lt;?${t.nodeValue}?>`;break;case Node.COMMENT_NODE:i+=`&lt;!--${t.nodeValue}--\x3e`;break;default:i+=t.nodeValue.replace(/</g,"&lt;")}return!t&&e.childNodes.length>0&&(i+=`&lt;/${e.getAttribute("data-origname")}>`),i}hideContent(e,t=!0){if(e.childNodes.length>0){const i=document.createElement("span");e.appendChild(i),i.setAttribute("hidden",""),i.setAttribute("data-original","");for(const t of Array.from(e.childNodes))t!==i&&i.appendChild(e.removeChild(t));if(t)for(const e of Array.from(i.querySelectorAll("*")))e.hasAttribute("id")&&(e.setAttribute("data-origid",e.getAttribute("id")),e.removeAttribute("id"))}}unEscapeEntities(e){return e.replace(/&gt;/,">").replace(/&quot;/,'"').replace(/&apos;/,"'").replace(/&amp;/,"&")}static savePosition(){window.localStorage.setItem("scroll",window.scrollY)}static restorePosition(){window.location.hash?setTimeout(()=>{document.querySelector(window.location.hash).scrollIntoView()},100):window.localStorage.getItem("scroll")&&setTimeout(()=>{window.scrollTo(0,localStorage.getItem("scroll"))},100)}fromODD(){}}try{if(window){window.CETEI=t,window.addEventListener("beforeunload",t.savePosition);var i=new Event("ceteiceanload");window.addEventListener("ceteiceanload",t.restorePosition)}}catch(e){}return t}();class n extends e{static get styles(){return[t`
      :host {
        display: inline-flex;
      }
      a {
        text-indent: 0;
      }
      simple-popover {
        max-width: 50vw;
      }
      simple-popover a {
        display: block;
        width: 16px;
        margin-left: auto;
        margin-right: 0;
      }
      simple-icon {
        --simple-icon-height: 16px;
        --simple-icon-width: 16px;
      }
    `]}static get properties(){return{icon:{type:String},hiddenStatus:{type:Boolean},title:{type:String}}}constructor(){super(),this.icon="av:note",this.markerType="icon",this.hiddenStatus=!0,this.title="View additional notes"}static get tag(){return"tei-note"}firstUpdated(){super.firstUpdated&&super.firstUpdated(),setTimeout(()=>{this.shadowRoot.querySelector("simple-popover").target=this.shadowRoot.querySelector("a")},0)}render(){return i`
    <a href="javascript:void(0);" title="${this.title}" icon="${this.icon}" @click="${this.toggleStatus}">
      <simple-icon icon="info-outline"></simple-icon>
    </a>
    <simple-popover auto ?hidden="${this.hiddenStatus}">
      <a href="javascript:void(0);" title="Close Popover" @click="${this.toggleStatus}">
        <simple-icon icon="close"></simple-icon>
      </a>
      <slot></slot>
    </simple-popover>
    `}toggleStatus(e){this.hiddenStatus=!this.hiddenStatus}}customElements.define(n.tag,n);window.customElements.define("tei-render",class extends e{constructor(){super(),this.CETEIcean=new s,this.src=null,this.validModes=Object.keys({drama:"Drama",dramae:"DramaEdited",play:"Play"}),this.mode="drama",this.basePath=this.pathFromUrl(decodeURIComponent(import.meta.url)),this.pathAssetCss="../lib/css",this.closeIcon="close",this.closeLabel="Close",this.copyMessage="Copied to Clipboard",this.linkIcon="link",this.linkLabel="Get link",this.lineDisplay=5,this.linePrefix="line",this.lineStart=1,this.pageIcon="description",this.pageLabel="See the original page"}static get properties(){return{src:{type:String},mode:{type:String},pathAssetCss:{type:String},lineDisplay:{type:String},linePrefix:{type:String},lineStart:{type:String},closeIcon:{type:String},closeLabel:{type:String},copyMessage:{type:String},currentLineId:{type:String},linkIcon:{type:String},linkLabel:{type:String},pageIcon:{type:String},pageLabel:{type:String},toast:{type:Object}}}updated(e){e.forEach((e,t)=>{"src"===t&&this[t]&&this.teiRender(),"mode"===t&&this[t]&&this._modeChanged(this[t])})}_modeChanged(e){this.validModes.includes(e)&&this.applyModeStyles(e)}teiRender(){try{this.CETEIcean.addBehaviors({handlers:{lb:function(e){e.innerHTML=e.parentNode.lastChild.textContent,e.parentNode.lastChild.textContent=""},pb:function(e){let t=document.createElement("simple-icon-button-lite");t.setAttribute("icon","description"),t.setAttribute("label",this.pageLabel);let i=document.createElement("a");return i.setAttribute("href",e.getAttribute("facs")),i.appendChild(t),i},add:["`","´"]}}),this.CETEIcean.getHTML5(this.src,e=>{this.innerHTML="",this.validModes.includes(this.mode)&&this.applyModeStyles(this.mode),this.appendChild(e);let t=this.querySelectorAll("tei-l"),i=(this.lineStart,this.linePrefix||"line");i=i,t&&[...t].forEach((e,t)=>{let s=t+1,n=`${i}-${s}`,o=document.createElement("simple-icon-button-lite");e.setAttribute("id",n),s%this.lineDisplay!=0&&1!==s||e.setAttribute("data-lineno",s),o.setAttribute("aria-controls","relative-heading-toast"),o.setAttribute("icon",this.linkIcon),o.setAttribute("label",this.linkLabel),o.addEventListener("click",e=>this._handleCopyClick(n)),e.prepend(o)})})}catch(e){console.log("Error in getting the document.")}}applyModeStyles(e){if(this.querySelector("#teirenderstyletag"))this.querySelector("#teirenderstyletag").innerHTML="";else{let e=document.createElement("style");e.id="teirenderstyletag",this.children&&this.children.length>0?this.insertBefore(e,this.children[0]):this.appendChild(e)}fetch(`${this.basePath}/${this.pathAssetCss}/${e}.css`).then(e=>e.text()).then(e=>{this.querySelector("#teirenderstyletag").innerHTML=e}).catch(t=>{console.warn("CSS file failed to load file with a mode of "+e)})}createRenderRoot(){return this}pathFromUrl(e){return e.substring(0,e.lastIndexOf("/")+1)}get anchored(){return!(!window.AnchorBehaviors||!window.AnchorBehaviors.getTarget)&&window.AnchorBehaviors.getTarget(this)}_handleCopyClick(e){this.copyLink(e)}copyLink(e){let t=document.createElement("textarea");this.currentLineId=`${window.location.href.replace(window.location.hash,"")}#${e}`,console.log("copylink",this.currentLineId),t.value=this.currentLineId,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),this.dispatchEvent(new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:`Copied link ${this.currentLineId} to your clipboard`,duration:3e3}}))}static get haxProperties(){return{canScale:!1,canPosition:!1,canEditSource:!1,gizmo:{title:"TEI Document",description:"Display a TEI document in the browser",icon:"book",color:"green",groups:["Content","Creative Commons"],handles:[{type:"content",title:"search"}],meta:{author:"Penn State Libraries"}},settings:{quick:[],configure:[{property:"src",title:"Source",description:"source of the TEI file",inputMethod:"haxupload",icon:"link",validationType:"url",required:!0},{property:"mode",title:"Mode",description:"Mode of presenting this",inputMethod:"select",options:{drama:"Drama",dramae:"DramaEdited",play:"Play"}}]},saveOptions:{wipeSlot:!0,unsetAttributes:["basePath"]}}}});
